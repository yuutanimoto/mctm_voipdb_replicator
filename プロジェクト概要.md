# McTM VoipDB Replicator - プロジェクト概要

## プロジェクト概要

**McTM VoipDB Replicator**は、SQL ServerからPostgreSQLへのデータ同期を自動化するAWS Lambda基盤のシステムです。複数のソースデータベース（McTM、VoipDB）から必要なテーブルデータを定期的にPostgreSQLに複製し、データの一元管理を実現します。

### プロジェクト背景・経緯

DX推進部より、社内システム「モバリンク」でSIM等の顧客情報を管理する機能を作成する要望があり、この機能実装のためにMcTMレプリカDBの作成とデータアクセス環境の整備が必要となりました。

**関連メッセージ**: http://192.168.254.32/cgi-bin/cbgrn/grn.exe/message/view?cid=1563&rid=212402&mid=227417&login-submit=%E3%83%AD%E3%82%B0%E3%82%A4%E3%83%B3

## システムアーキテクチャ

### 基本構成
```
[SQL Server - McTM]    ────┐
(10.35.11.13)              │
                           ├──→ [AWS Lambda] ──→ [PostgreSQL RDS]
[SQL Server - VoipDB]  ────┘    (データ処理)      (統合DB)
(10.35.11.14)
```

### 実行環境
- **AWS Lambda**: メイン実行環境
- **EventBridge**: スケジューラ（1日3回: 8:00, 12:30, 16:00）
- **CloudWatch**: ログ監視
- **処理時間**: 約2分

## 対象データベース・テーブル

### ソースデータベース
1. **McTM Database** (10.35.11.13)
   - customer（顧客マスタ）
   - mctm_module（モジュール管理）

2. **VoipDB Database** (10.35.11.14)
   - voipdb_customer（VoIP顧客情報）
   - voipdb_useragent（ユーザーエージェント）

### ターゲットデータベース
- **PostgreSQL RDS**: dx_sim_management_db
- 正規化された命名規則でテーブル作成

## 技術スタック

### 言語・フレームワーク
- **Python 3.13**: メイン開発言語
- **pymssql**: SQL Server接続
- **psycopg2**: PostgreSQL接続
- **boto3**: AWS Lambda実行環境

### AWS サービス
- **Lambda**: データ処理実行
- **EventBridge**: スケジュール実行
- **CloudWatch**: ログ・監視
- **RDS (PostgreSQL)**: データ保存

## プロジェクト構成

### ディレクトリ構造
```
mctm_voipdb_replicator/
├── lambda_deployment_postgresql_updated/  # メインコード
│   ├── lambda_function.py                 # エントリーポイント
│   ├── multi_table_manager.py             # バッチ同期管理
│   ├── table_sync_processor.py            # 個別テーブル処理
│   ├── table_configs.py                   # テーブル定義
│   ├── config.py                          # 環境変数管理
│   └── build.sh                           # デプロイ用ビルドスクリプト
├── .env.example                           # 環境変数テンプレート
├── README.md                              # 開発・運用手順書
├── 運用マニュアル.md                        # 運用時参照資料
├── EventBridge設定.md                      # スケジューラ設定手順
└── CLAUDE.md                              # コード開発ガイド
```

### 主要コンポーネント

1. **lambda_function.py**: AWS Lambdaエントリーポイント、CLI対応
2. **multi_table_manager.py**: 複数テーブルの順次同期とプログレス管理
3. **table_sync_processor.py**: 個別テーブル同期とバッチ処理
4. **table_configs.py**: テーブル設定の一元管理
5. **config.py**: 環境変数の検証・管理

## データ処理フロー

### 同期処理の流れ
1. **データ抽出**: SQL ServerからSELECTクエリ（NOLOCK使用）
2. **バッチ処理**: 10,000件単位でのメモリ効率的な処理
3. **データ挿入**: PostgreSQLにexecute_valuesで高速挿入
4. **完全同期**: TRUNCATE + INSERT方式で整合性保証

### 実行パターン
- **順次処理**: リソース競合回避のため1テーブルずつ処理
- **トランザクション**: 失敗時の自動ロールバック
- **エラーハンドリング**: 包括的なエラー処理とログ出力

## 環境設定

### 必要な環境変数

#### McTM Database接続
```bash
SQL_SERVER_MCTM_HOST=10.35.11.13        # ローカル実行時
SQL_SERVER_MCTM_HOST=imesh-fdc-mdb-mctm-pri.private  # Lambda実行時
SQL_SERVER_MCTM_DB=McTM
SQL_SERVER_MCTM_USER=sa
SQL_SERVER_MCTM_PASSWORD=M0biCri3720
SQL_SERVER_MCTM_PORT=1433
```

#### VoipDB Database接続
```bash
SQL_SERVER_VOIPDB_HOST=10.35.11.14       # ローカル実行時
SQL_SERVER_VOIPDB_HOST=imesh-fdc-mdb-voipdb-pri.private  # Lambda実行時
SQL_SERVER_VOIPDB_DB=VoipDB
SQL_SERVER_VOIPDB_USER=sa
SQL_SERVER_VOIPDB_PASSWORD=M0biCri3720
SQL_SERVER_VOIPDB_PORT=1433
```

#### PostgreSQL接続
```bash
PG_HOST=mdb-copy-internaluse-db.canwpjocubwd.ap-northeast-1.rds.amazonaws.com
PG_DB=dx_sim_management_db
PG_USER=postgres
PG_PASSWORD=E9XyF-KV$D$4iCqhHkuE_r*R601i
PG_PORT=5432
```

## 開発・運用手順

### ローカル開発環境

#### 前提条件
- WSL Ubuntu 24.04.1 LTS（必須）
- Python 3.13
- Cursor エディタ

#### セットアップ手順
```bash
# 1. プロジェクト配置
cd /home/init_user/mctm_voipdb_replicator

# 2. 仮想環境作成・有効化
python3.13 -m venv .venv
source .venv/bin/activate

# 3. 環境設定
cp .env.example .env
# .envファイルを適切に編集

# 4. 実行テスト
cd lambda_deployment_postgresql_updated
python lambda_function.py multi_test    # 接続テスト
python lambda_function.py info          # テーブル情報確認
python lambda_function.py               # 全テーブル同期実行
```

### Lambda デプロイメント

#### ビルド・デプロイ手順
```bash
# 1. ビルド環境（WSL Ubuntu必須）
cd lambda_deployment_postgresql_updated

# 2. 追加ライブラリインストール（必要時）
pip install [ライブラリ名] -t .

# 3. デプロイパッケージ作成
chmod +x build.sh
./build.sh

# 4. Lambda関数更新
# lambda_function_with_postgresql.zip をAWS Lambdaにアップロード
```

#### 重要な注意事項
- **WSL Ubuntu必須**: pymssql、psycopg2等のC系ライブラリ互換性のため
- **Windows環境NG**: バイナリ互換性がないため動作しない

## AWS設定情報

### Lambda関数設定
- **関数名**: mctm-replica-db-copy-func
- **タイムアウト**: 10分
- **メモリ**: 512MB
- **実行時間**: 約2分

### EventBridge スケジュール
- **ルール名**: mctm-replica-db-copy-schedule
- **実行頻度**: 1日3回
- **実行時間**: 
  - 08:00 JST (23:00 UTC)
  - 12:30 JST (03:30 UTC)
  - 16:00 JST (07:00 UTC)

### 監視・ログ
- **CloudWatch ログ**: `/aws/lambda/mctm-replica-db-copy-func`
- **URL**: https://ap-northeast-1.console.aws.amazon.com/cloudwatch/home?region=ap-northeast-1#logsV2:log-groups/log-group/$252Faws$252Flambda$252Fmctm-replica-db-copy-func

## 運用上の注意事項

### 基本ルール
1. **コード修正は必ずUbuntu環境で実施**
2. **修正後は必ずビルド→Lambda更新が必要**
3. **本番テストはLambdaコンソールのテスト機能を使用**

### トラブルシューティング
1. **実行エラー**: CloudWatchログで詳細確認
2. **接続エラー**: 環境変数、ネットワーク設定確認
3. **タイムアウト**: Lambda設定、データ量確認

### 機能拡張時の手順
1. **新テーブル追加**: `table_configs.py`に設定追加
2. **処理ロジック変更**: 該当コンポーネント修正
3. **テスト実行**: ローカル→Lambda順でテスト
4. **本番デプロイ**: build.sh実行→Lambda更新

## セキュリティ・コンプライアンス

### データベース接続
- 専用サービスアカウント使用
- 読み取り専用権限（ソース）
- 書き込み権限は必要最小限（ターゲット）

### AWS環境
- Lambda実行ロールの適切な権限設定
- VPC内プライベート通信
- ログデータの適切な保持期間設定

### データハンドリング
- 機密情報のログ出力防止
- トランザクションによる整合性保証
- エラー時の適切なロールバック処理

## よくある質問・トラブル

### Q: データ同期が失敗する
A: CloudWatchログで詳細確認。接続エラーの場合は環境変数、ネットワーク設定をチェック

### Q: 新しいテーブルを追加したい
A: `table_configs.py`にテーブル設定を追加し、テスト実行後にLambda更新

### Q: Windows環境でエラーになる
A: WSL Ubuntu環境でのビルドが必須。Windowsでビルドしたパッケージは動作しない

### Q: 実行時間が長すぎる
A: バッチサイズ調整、Lambda設定（メモリ・タイムアウト）の見直し

---

**更新履歴**
- 作成日: 2025-09-01
- 作成者: Claude Code
- 版数: v1.0

**関連ドキュメント**
- README.md: 詳細な開発・デプロイ手順
- 運用マニュアル.md: 運用時の参照資料  
- EventBridge設定.md: スケジューラ設定詳細
- CLAUDE.md: コード開発ガイドライン
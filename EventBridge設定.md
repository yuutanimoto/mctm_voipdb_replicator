# EventBridge設定手順書

AWS EventBridgeを使用してLambda関数を1日4回自動実行するスケジュール設定手順

## 概要

- **目的**: mctm_voipdb_replicatorのLambda関数を定期実行
- **実行頻度**: 1日3回
- **実行時間**: 23:00, 03:30, 07:00（UTC）※日本時間 8:00, 12:30, 16:00
- **設定方法**: AWSコンソールでEventBridgeルール作成

## 前提条件

- Lambda関数が正常にデプロイ済み
- AWSコンソールにログイン済み
- EventBridge、Lambdaサービスへのアクセス権限を保有

## 設定手順

### 1. EventBridgeサービスにアクセス

```
1. AWSコンソールにログイン
2. サービス検索で「EventBridge」と入力
3. 「Amazon EventBridge」をクリック
```

### 2. ルールの作成開始

```
1. 左側メニューから「ルール」をクリック
2. 「ルールを作成」ボタンをクリック
3. 「デフォルトのイベントバス」が選択されていることを確認
```

### 3. ルール詳細の設定

#### 3-1. ルール名と説明

```
名前: mctm-replica-db-copy-schedule
説明: McTM VoipDB Replicator 定期実行ルール (1日3回: 8:00,12:30,16:00)
```

#### 3-2. ルールタイプの選択

```
• 「スケジュール」を選択
• 「次へ」をクリック
```

### 4. スケジュールの設定

#### 4-1. スケジュール式の選択

```
• 「スケジュール式」を選択
• 以下の3つのルールを個別に作成する必要があります:

ルール1 - 朝8時実行用:
  cron(0 23 * * ? *)

ルール2 - 昼12時30分実行用:
  cron(30 3 * * ? *)

ルール3 - 夕16時実行用:
  cron(0 7 * * ? *)
```

#### 4-2. 3つのルールの作成手順

**この手順を3回繰り返して、以下のルールを個別に作成してください:**

```
ルール1: mctm-replica-db-copy-schedule-08
  cron(0 23 * * ? *)  # UTC 23:00 = JST 08:00

ルール2: mctm-replica-db-copy-schedule-1230  
  cron(30 3 * * ? *)  # UTC 03:30 = JST 12:30

ルール3: mctm-replica-db-copy-schedule-16
  cron(0 7 * * ? *)   # UTC 07:00 = JST 16:00
```

**cron式の説明:**
```
cron(分 時 日 月 曜日 年)
  └─ 0: 0分（全て0分ちょうど）
     └─ 23,3,7: 各実行時間(UTC)
        └─ *: 毎日
           └─ *: 毎月
              └─ ?: 曜日指定なし
                 └─ *: 毎年
```

#### 4-3. タイムゾーンの設定

```
• タイムゾーン: UTC
• フレキシブルタイムウィンドウ: オフ
• 「次へ」をクリック
```

### 5. ターゲットの設定

#### 5-1. ターゲットタイプの選択

```
• 「AWSサービス」を選択
• サービスから「Lambda関数」を選択
```

#### 5-2. Lambda関数の指定

```
• 関数: 作成したLambda関数名を選択
  例: mctm-replica-db-copy-func
```

#### 5-3. 追加設定

```
• 入力の設定: 「一致したイベント」（デフォルト）
• 追加設定は変更不要
• 「次へ」をクリック
```

### 6. 権限とレビュー

#### 6-1. 実行ロールの設定

```
• 「この特定のリソース用に新しいロールを作成する」を選択
• ロール名: EventBridgeExecuteRole-mctm-replica-db-copy
• 「次へ」をクリック
```

#### 6-2. 設定内容の確認

```
以下の項目を確認:
• ルール名: mctm-replica-db-copy-schedule
• スケジュール: 各ルールのcron式を確認
• ターゲット: Lambda関数
• 関数名: 指定したLambda関数名
```

#### 6-3. ルールの作成

```
• 内容に問題がなければ「ルールを作成」をクリック
• 作成完了メッセージを確認
```

## 実行時間の詳細

### UTC時間と日本時間の対応

| UTC時間 | 日本時間（JST） | ルール名 |
|---------|----------------|----------|
| 23:00   | 08:00          | schedule-08 |
| 03:30   | 12:30          | schedule-1230 |
| 07:00   | 16:00          | schedule-16 |

## 設定後の確認手順

### 1. ルール状態の確認

```
1. EventBridge > ルール
2. 作成したルール「mctm-replica-db-copy-schedule」をクリック
3. 状態が「有効」になっていることを確認
```

### 2. 次回実行時間の確認

```
• ルール詳細画面で「次の実行予定時刻」を確認
• 想定通りの時間が表示されているか確認
```

### 3. 手動テスト実行

```
1. Lambda > 関数 > 該当関数を選択
2. 「テスト」タブをクリック
3. 新しいテストイベントを作成:
   - テンプレート: EventBridge (CloudWatch Events)
   - イベント名: eventbridge-test
4. 「テスト」をクリックして正常実行を確認
```

## 監視とトラブルシューティング

### 1. CloudWatchログの確認

```
1. CloudWatch > ログ > ロググループ
2. `/aws/lambda/関数名` を選択
3. 実行ログとエラーログを確認
```

### 2. EventBridge実行履歴の確認

```
1. EventBridge > ルール > 該当ルール
2. 「メトリクス」タブで実行回数を確認
3. 「監視」タブでエラー発生状況を確認
```

### 3. よくある問題と解決方法

#### 3-1. Lambda関数が実行されない

**原因**: IAM権限不足
**解決**: 
```
1. IAM > ロール > EventBridgeExecuteRole-mctm-replica-db-copy
2. 権限ポリシーにlambda:InvokeFunction権限があることを確認
3. なければポリシーを追加
```

#### 3-2. 実行時刻がずれる

**原因**: タイムゾーン設定ミス
**解決**:
```
1. EventBridge > ルール > 該当ルール > 編集
2. スケジュール設定でタイムゾーンを再確認
3. 必要に応じてcron式を修正
```

## 運用上の注意事項

### 1. Lambda実行時間制限

```
• デフォルト: 3秒
• 推奨: 15分（900秒）
• データ量に応じて調整が必要
```

### 2. 同時実行制御

```
• Lambda関数の同時実行数制限を設定推奨
• 前の実行が完了前に次の実行が開始されるのを防ぐ
```

### 3. エラーハンドリング

```
• 失敗時の再試行設定
• Dead Letter Queue（DLQ）の設定検討
• アラート通知の設定
```

## 費用について

### EventBridge料金

```
• 無料枠: 月間1400万回まで無料
• 1日3回 × 30日 = 90回/月 → 無料範囲内
```

### Lambda料金

```
• 実行回数: 1日3回 × 30日 = 90回/月
• 実行時間: データ量による（要監視）
• 無料枠内で収まる可能性が高い
```

## 設定完了チェックリスト

- [ ] EventBridgeルールが「有効」状態
- [ ] cron式が正しく設定されている
- [ ] Lambda関数が正しく選択されている
- [ ] IAMロールが適切に作成されている
- [ ] 手動テストが正常に実行される
- [ ] CloudWatchログが出力されている
- [ ] 次回実行時間が想定通り